<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Data Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg shadow-lg p-8 mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">üèÉ Running Data Tracker</h1>
                <p class="text-blue-100">Weekly running goals and performance</p>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">Loading your running data...</p>
            </div>

            <!-- Error State -->
            <div id="error" class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-8 rounded">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700" id="error-message"></p>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div id="stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500 mb-2">Total Goal</div>
                    <div class="text-3xl font-bold text-blue-600" id="total-goal">0</div>
                    <div class="text-xs text-gray-500 mt-1">km planned</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500 mb-2">Total Actual</div>
                    <div class="text-3xl font-bold text-green-600" id="total-actual">0</div>
                    <div class="text-xs text-gray-500 mt-1">km completed</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500 mb-2">Completion Rate</div>
                    <div class="text-3xl font-bold text-indigo-600" id="completion-rate">0%</div>
                    <div class="text-xs text-gray-500 mt-1">of total goal</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500 mb-2">Avg per Week</div>
                    <div class="text-3xl font-bold text-purple-600" id="avg-week">0</div>
                    <div class="text-xs text-gray-500 mt-1">km average</div>
                </div>
            </div>

            <!-- Charts -->
            <div id="charts" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Weekly Progress</h2>
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Goal vs Actual</h2>
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Data Table -->
            <div id="table-container" class="hidden bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">Weekly Data</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Goal (km)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actual (km)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Difference</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Achievement</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SPREADSHEET_ID = '1KPvX-cE6RZBzyPGtFLnujwzNohfvxEPftuwqWz6G7p8';
        const SHEET_NAME = 'High level planning';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

        let weeklyChart, comparisonChart;

        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Failed to fetch data. Make sure the sheet is publicly accessible.');
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                    },
                    error: function(error) {
                        showError('Error parsing CSV: ' + error.message);
                    }
                });
            } catch (error) {
                showError(error.message);
            }
        }

        function processData(data) {
            // Filter out rows with missing data
            const validData = data.filter(row => 
                row['Week'] && 
                (row['Goal (km)'] !== null && row['Goal (km)'] !== undefined) && 
                (row['Actual (km)'] !== null && row['Actual (km)'] !== undefined)
            );

            if (validData.length === 0) {
                showError('No valid data found in the sheet.');
                return;
            }

            // Calculate statistics
            const totalGoal = validData.reduce((sum, row) => sum + (parseFloat(row['Goal (km)']) || 0), 0);
            const totalActual = validData.reduce((sum, row) => sum + (parseFloat(row['Actual (km)']) || 0), 0);
            const completionRate = totalGoal > 0 ? (totalActual / totalGoal * 100).toFixed(1) : 0;
            const avgWeek = validData.length > 0 ? (totalActual / validData.length).toFixed(1) : 0;

            // Update stats
            document.getElementById('total-goal').textContent = totalGoal.toFixed(1);
            document.getElementById('total-actual').textContent = totalActual.toFixed(1);
            document.getElementById('completion-rate').textContent = completionRate + '%';
            document.getElementById('avg-week').textContent = avgWeek;

            // Create charts
            createCharts(validData);

            // Create table
            createTable(validData);

            // Show content
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('stats').classList.remove('hidden');
            document.getElementById('charts').classList.remove('hidden');
            document.getElementById('table-container').classList.remove('hidden');
        }

        function createCharts(data) {
            const weeks = data.map(row => 'Week ' + row['Week']);
            const goals = data.map(row => parseFloat(row['Goal (km)']) || 0);
            const actuals = data.map(row => parseFloat(row['Actual (km)']) || 0);

            // Weekly Progress Chart
            const ctx1 = document.getElementById('weeklyChart').getContext('2d');
            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Goal',
                            data: goals,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Actual',
                            data: actuals,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Kilometers'
                            }
                        }
                    }
                }
            });

            // Comparison Chart
            const ctx2 = document.getElementById('comparisonChart').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();
            comparisonChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Goal',
                            data: goals,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)'
                        },
                        {
                            label: 'Actual',
                            data: actuals,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Kilometers'
                            }
                        }
                    }
                }
            });
        }

        function createTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            data.forEach(row => {
                const week = row['Week'];
                const goal = parseFloat(row['Goal (km)']) || 0;
                const actual = parseFloat(row['Actual (km)']) || 0;
                const difference = actual - goal;
                const achievement = goal > 0 ? (actual / goal * 100).toFixed(1) : 0;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                const diffColor = difference >= 0 ? 'text-green-600' : 'text-red-600';
                const achievementColor = achievement >= 100 ? 'bg-green-100 text-green-800' : 
                                        achievement >= 80 ? 'bg-yellow-100 text-yellow-800' : 
                                        'bg-red-100 text-red-800';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Week ${week}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${goal.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${actual.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${diffColor}">
                        ${difference >= 0 ? '+' : ''}${difference.toFixed(1)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${achievementColor}">
                            ${achievement}%
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        // Load data on page load
        fetchData();
    </script>
</body>
</html>
